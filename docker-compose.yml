services:
  nats:
    image: nats:2.10.11-alpine
    restart: unless-stopped
    networks:
      - backend

  messenger-gateway:
    image: ghcr.io/${GHCR_USER}/messenger-gateway:latest
    env_file:
      - ./.env
    depends_on:
      - nats
    restart: unless-stopped
    networks:
      - edge
      - backend
    environment:
      - VIRTUAL_HOST=${MESSENGER_GATEWAY_VIRTUAL_HOST}
      - VIRTUAL_PORT=3000
      - LETSENCRYPT_HOST=${MESSENGER_GATEWAY_VIRTUAL_HOST}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}

  messenger-line-webhook:
    image: ghcr.io/${GHCR_USER}/messenger-line-webhook:latest
    env_file:
      - ./.env
    depends_on:
      - nats
    restart: unless-stopped
    networks:
      - edge
      - backend
    environment:
      - VIRTUAL_HOST=${MESSENGER_LINE_WEBHOOK_VIRTUAL_HOST}
      - VIRTUAL_PORT=8080
      - LETSENCRYPT_HOST=${MESSENGER_LINE_WEBHOOK_VIRTUAL_HOST}
      - LETSENCRYPT_EMAIL=${MESSENGER_LINE_WEBHOOK_LETSENCRYPT_EMAIL}

  messenger-line-worker:
    image: ghcr.io/${GHCR_USER}/messenger-line-worker:latest
    env_file:
      - ./.env
    depends_on:
      - nats
    restart: unless-stopped
    networks:
      - backend

  messenger-discord-incoming-worker:
    image: ghcr.io/${GHCR_USER}/messenger-discord-incoming-worker:latest
    env_file:
      - ./.env
    depends_on:
      - nats
    restart: unless-stopped
    networks:
      - backend

  auth-line:
    image: ghcr.io/${GHCR_USER}/auth-line:latest
    env_file:
      - ./.env
    restart: unless-stopped
    networks:
      - edge
    environment:
      - VIRTUAL_HOST=${AUTH_LINE_VIRTUAL_HOST}
      - VIRTUAL_PORT=8080
      - LETSENCRYPT_HOST=${AUTH_LINE_VIRTUAL_HOST}
      - LETSENCRYPT_EMAIL=${AUTH_LINE_LETSENCRYPT_EMAIL}

  auth-twitter:
    image: ghcr.io/${GHCR_USER}/auth-twitter:latest
    env_file:
      - ./.env
    restart: unless-stopped
    networks:
      - edge
    environment:
      - VIRTUAL_HOST=${AUTH_TWITTER_VIRTUAL_HOST}
      - VIRTUAL_PORT=8080
      - LETSENCRYPT_HOST=${AUTH_TWITTER_VIRTUAL_HOST}
      - LETSENCRYPT_EMAIL=${AUTH_TWITTER_LETSENCRYPT_EMAIL}

  media-static:
    image: nginx:alpine
    restart: unless-stopped
    networks:
      - edge
    volumes:
      - ${MEDIA_ROOT_HOST_PATH:-./media-static}:/usr/share/nginx/html:ro
    environment:
      - VIRTUAL_HOST=${MEDIA_VIRTUAL_HOST}
      - VIRTUAL_PORT=80
      - LETSENCRYPT_HOST=${MEDIA_VIRTUAL_HOST}
      - LETSENCRYPT_EMAIL=${MEDIA_LETSENCRYPT_EMAIL}

networks:
  edge:
    external: true
    name: project01-edge
  backend:
    driver: bridge
